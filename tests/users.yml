---

- hosts: localhost
  gather_facts: false

  vars:

    manala_accounts_groups:
      - group_1
      - group_2

    manala_accounts_users:
      - user:  user_1
        group: group_1
        authorized_keys:
          - "{{ lookup('file', playbook_dir ~ '/keys/user_1.pub') }}"
      - user:  user_2
        group: group_2
        groups:
          - group_1
        authorized_keys:
          - "{{ lookup('file', playbook_dir ~ '/keys/user_1.pub') }}"
          - "{{ lookup('file', playbook_dir ~ '/keys/user_2.pub') }}"
      - user:  user_3
        group: users
        authorized_keys_file: authorized_keys2
        authorized_keys:
          - "{{ lookup('file', playbook_dir ~ '/keys/user_2.pub') }}"
          - "{{ lookup('file', playbook_dir ~ '/keys/user_3.pub') }}"
      - user:  user_4
        group: users
        authorized_keys_file: /home/user_4/.ssh/authorized_keys3
        authorized_keys:
          - "{{ lookup('file', playbook_dir ~ '/keys/user_2.pub') }}"
          - "{{ lookup('file', playbook_dir ~ '/keys/user_3.pub') }}"
      - user: user_5
      - user: user_6
        authorized_keys_file: "{{ omit }}"
        authorized_keys:
          - "{{ lookup('file', playbook_dir ~ '/keys/user_1.pub') }}"
      - user: user_7
        authorized_keys_file: ~
        authorized_keys:
          - "{{ lookup('file', playbook_dir ~ '/keys/user_1.pub') }}"
      - user: user_8
        authorized_keys_file: ""
        authorized_keys:
          - "{{ lookup('file', playbook_dir ~ '/keys/user_1.pub') }}"

  pre_tasks:

    - shell: groupdel group_1 || true
    - shell: groupdel group_2 || true
    - shell: groupdel user_5 || true
    - shell: groupdel user_6 || true
    - shell: groupdel user_7 || true
    - shell: groupdel user_8 || true
    - shell: userdel -r user_1 || true
    - shell: userdel -r user_2 || true
    - shell: userdel -r user_3 || true
    - shell: userdel -r user_4 || true
    - shell: userdel -r user_5 || true
    - shell: userdel -r user_6 || true
    - shell: userdel -r user_7 || true
    - shell: userdel -r user_8 || true

  roles:
    - manala.accounts

  post_tasks:

    # Goss
    - name: Goss
      raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss -g - validate' }}"
      with_items:
        - group:
            group_1:
              exists: true
            group_2:
              exists: true
            user_5:
              exists: true
            user_6:
              exists: true
            user_7:
              exists: true
            user_8:
              exists: true
        - user:
            user_1:
              exists: true
              home:   /home/user_1
              shell:  /bin/sh
              groups:
                - group_1
            user_2:
              exists: true
              home:   /home/user_2
              shell:  /bin/sh
              groups:
                - group_2
                - group_1
            user_3:
              exists: true
              home:   /home/user_3
              shell:  /bin/sh
              groups:
                - users
            user_4:
              exists: true
              home:   /home/user_4
              shell:  /bin/sh
              groups:
                - users
            user_5:
              exists: true
              home:   /home/user_5
              shell:  /bin/sh
              groups:
                - user_5
            user_6:
              exists: true
              home:   /home/user_6
              shell:  /bin/sh
              groups:
                - user_6
            user_7:
              exists: true
              home:   /home/user_7
              shell:  /bin/sh
              groups:
                - user_7
            user_8:
              exists: true
              home:   /home/user_8
              shell:  /bin/sh
              groups:
                - user_8
        - file:
            /home/user_1/.ssh/authorized_keys:
              exists:   true
              filetype: file
              owner:    user_1
              group:    group_1
              mode:     "0600"
              contains:
                - "{{ lookup('file', playbook_dir ~ '/keys/user_1.pub') }}"
                - "!{{ lookup('file', playbook_dir ~ '/keys/user_2.pub') }}"
                - "!{{ lookup('file', playbook_dir ~ '/keys/user_3.pub') }}"
            /home/user_2/.ssh/authorized_keys:
              exists:   true
              filetype: file
              owner:    user_2
              group:    group_2
              mode:     "0600"
              contains:
                - "{{ lookup('file', playbook_dir ~ '/keys/user_1.pub') }}"
                - "{{ lookup('file', playbook_dir ~ '/keys/user_2.pub') }}"
                - "!{{ lookup('file', playbook_dir ~ '/keys/user_3.pub') }}"
            /home/user_3/.ssh/authorized_keys:
              exists:   false
              filetype: file
            /home/user_3/.ssh/authorized_keys2:
              exists:   true
              filetype: file
              owner:    user_3
              group:    users
              mode:     "0600"
              contains:
                - "!{{ lookup('file', playbook_dir ~ '/keys/user_1.pub') }}"
                - "{{ lookup('file', playbook_dir ~ '/keys/user_2.pub') }}"
                - "{{ lookup('file', playbook_dir ~ '/keys/user_3.pub') }}"
            /home/user_4/.ssh/authorized_keys:
              exists:   false
              filetype: file
            /home/user_4/.ssh/authorized_keys3:
              exists:   true
              filetype: file
              owner:    user_4
              group:    users
              mode:     "0600"
              contains:
                - "!{{ lookup('file', playbook_dir ~ '/keys/user_1.pub') }}"
                - "{{ lookup('file', playbook_dir ~ '/keys/user_2.pub') }}"
                - "{{ lookup('file', playbook_dir ~ '/keys/user_3.pub') }}"
            /home/user_5/.ssh/authorized_keys:
              exists:   false
              filetype: file
            /home/user_6/.ssh/authorized_keys:
              exists:   true
              filetype: file
              owner:    user_6
              group:    user_6
              mode:     "0600"
              contains:
                - "{{ lookup('file', playbook_dir ~ '/keys/user_1.pub') }}"
            /home/user_7/.ssh/authorized_keys:
              exists:   true
              filetype: file
              owner:    user_7
              group:    user_7
              mode:     "0600"
              contains:
                - "{{ lookup('file', playbook_dir ~ '/keys/user_1.pub') }}"
